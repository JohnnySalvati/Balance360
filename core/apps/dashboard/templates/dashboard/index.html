{% extends "base.html" %}
{% load static %}
{% load humanize %}


{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/dashboard.css' %}">
{% endblock %}

{% block content %} 


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<hr>

<h1>Dashboard financiero</h1>

<div class="filters">

  <form method="get" class="filters-form">

    <label>Entidad:</label>
    <select name="entity" onchange="this.form.submit()">
      {% for e in entities %}
        <option value="{{ e.id }}" {% if e.id == entity.id %}selected{% endif %}>
          {{ e.name }}
        </option>
      {% endfor %}
    </select>

    <label>Mes:</label>
    <select name="month" onchange="this.form.submit()">
      {% for m in context_months %}
        <option value="{{ m }}" {% if m == context_month %}selected{% endif %}>
          {{ m }}
        </option>
      {% endfor %}
    </select>

    <label>A침o:</label>
    <select name="year" onchange="this.form.submit()">
      {% for y in context_years %}
        <option value="{{ y }}" {% if y == context_year %}selected{% endif %}>
          {{ y }}
        </option>
      {% endfor %}
    </select>

  </form>
</div>

<hr>

<div class="period-header">
  <h2 class="period-title">Resultado del per칤odo</h2>

  {% if period_status == "closed" %}
    <div class="period-status closed">
      游 Per칤odo cerrado
    </div>

  {% elif period_status == "partial" %}
    <div class="period-status partial">
      游리 Per칤odo parcialmente cerrado

      <div class="period-detail">
        <p><strong>Entidades cerradas:</strong></p>
        <ul>
          {% for e in closed_entities %}
            <li>游 {{ e.name }}</li>
          {% endfor %}
        </ul>

        <p><strong>Entidades abiertas:</strong></p>
        <ul>
          {% for e in open_entities %}
            <li>游리 {{ e.name }}</li>
          {% endfor %}
        </ul>

        <form method="post" action="{% url 'close_missing_periods' %}">
          {% csrf_token %}
          <input type="hidden" name="entity" value="{{ entity.id }}">
          <input type="hidden" name="year" value="{{ context_year }}">
          <input type="hidden" name="month" value="{{ context_month }}">
          <button type="submit" class="btn-action">
            Cerrar entidades abiertas
          </button>
        </form>
      </div>
    </div>

  {% else %}
    <div class="period-status open">
      游릭 Per칤odo abierto

      <form method="post" action="{% url 'close_period' %}" class="inline-form">
        {% csrf_token %}
        <input type="hidden" name="entity" value="{{ entity.id }}">
        <input type="hidden" name="year" value="{{ context_year }}">
        <input type="hidden" name="month" value="{{ context_month }}">
        <button type="submit" class="btn-action">
          游 Cerrar per칤odo
        </button>
      </form>
    </div>
  {% endif %}
</div>

<div class="kpi-container">
  <div class="kpi">
    <h3>Ingresos</h3>
    <p class="kpi-value positive">
      $ {{ period.ingresos|floatformat:2|intcomma }}
    </p>
  </div>
  <div class="kpi">
    <h3>Egresos</h3>
    <p class="kpi-value negative">
      $ {{ period.egresos|floatformat:2|intcomma }}
    </p>
  </div>
  <div class="kpi kpi-main">
    <h3>Resultado</h3>
    <p class="kpi-value {% if period.resultado >= 0 %}positive{% else %}negative{% endif %}">
      $ {{ period.resultado|floatformat:2|intcomma }}
    </p>
  </div>
</div>

<div class="charts-grid">
  <div class="card">
    <h2>Balance mensual</h2>
    <div class="chart-wrapper">
      <canvas id="monthlyChart"></canvas>
    </div>
  </div>

  {{ monthly_labels|json_script:"monthly-labels" }}
  {{ monthly_totals|json_script:"monthly-totals" }}

  <script>
    const labels = JSON.parse(
      document.getElementById("monthly-labels").textContent
    );

    const totals = JSON.parse(
      document.getElementById("monthly-totals").textContent
    );

    new Chart(document.getElementById("monthlyChart"), {
      type: "line",
      data: {
        labels: labels,
        datasets: [{
          label: "Balance",
          data: totals,
          borderColor: "#4f46e5",
          backgroundColor: "rgba(79,70,229,0.1)",
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
  </script>

  <div class="card">
    <h2>Egresos por categor칤a</h2>

    <div class="toolbar">
      <form method="get">
        <input type="hidden" name="entity" value="{{ entity.id }}">
        <input type="hidden" name="year" value="{{ context_year }}">
        <input type="hidden" name="month" value="{{ context_month }}">

        <label>Egresos por categor칤a:</label>
        <select name="cat_scope" onchange="this.form.submit()">
          <option value="all" {% if context_cat_scope == "all" %}selected{% endif %}>
            Hist칩rico
          </option>
          <option value="period" {% if context_cat_scope == "period" %}selected{% endif %}>
            Per칤odo seleccionado
          </option>
        </select>
      </form>
    </div>

    <div class="chart-wrapper">
      <canvas id="categoryChart"></canvas>
    </div>
  </div>

  {{ category_labels|json_script:"category-labels" }}
  {{ category_totals|json_script:"category-totals" }}

  <script>
    const catLabels = JSON.parse(
      document.getElementById("category-labels").textContent
    );

    const catTotals = JSON.parse(
      document.getElementById("category-totals").textContent
    );

    new Chart(document.getElementById("categoryChart"), {
      type: "pie",
      data: {
        labels: catLabels,
        datasets: [{
        data: catTotals,
        backgroundColor: [
          "#af4444",
          "#f97316",
          "#eab308",
          "#22c55e",
          "#3b82f6"
        ]
      }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
  </script>

  <div class="card">
    <h2>Distribuci칩n por cuenta</h2>

    <div class="toolbar">
      <form method="get">
        <input type="hidden" name="entity" value="{{ entity.id }}">
        <input type="hidden" name="year" value="{{ context_year }}">
        <input type="hidden" name="month" value="{{ context_month }}">

        <label>Distribuci칩n por cuenta:</label>
        <select name="acc_scope" onchange="this.form.submit()">
          <option value="all" {% if context_acc_scope == "all" %}selected{% endif %}>
            Saldo actual
          </option>
          <option value="period" {% if context_acc_scope == "period" %}selected{% endif %}>
            Movimiento del per칤odo
          </option>
        </select>
      </form>
    </div>

    <div class="chart-wrapper">
      <canvas id="accountChart"></canvas>
    </div>
  </div>

  {{ account_labels|json_script:"account-labels" }}
  {{ account_totals|json_script:"account-totals" }}

  <script>
    const accLabels = JSON.parse(
      document.getElementById("account-labels").textContent
    );

    const accTotals = JSON.parse(
      document.getElementById("account-totals").textContent
    );

    new Chart(document.getElementById("accountChart"), {
      type: "bar",
      data: {
        labels: accLabels,
        datasets: [{
        label: "Saldo",
        data: accTotals,
        backgroundColor: "#3b82f6"
      }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
  </script>
</div>

{% endblock %}
